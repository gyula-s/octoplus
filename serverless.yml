service: octoplus-benefits

custom:
  stateTableName: ${self:service}-state-${self:provider.stage}

provider:
  name: aws
  runtime: nodejs20.x  # Latest LTS version supported by AWS Lambda
  region: eu-west-1  # Ireland region - change if needed
  stage: ${opt:stage, 'dev'}  # Default to 'dev' stage
  timeout: 30
  memorySize: 128
  logRetentionInDays: 14  # Keep logs for 2 weeks
  environment:
    # DynamoDB state table
    STATE_TABLE_NAME: ${self:custom.stateTableName}
    # SSM Parameter Store path prefix
    SSM_PATH_PREFIX: /octoplus/${self:provider.stage}
    # Deployment stage
    STAGE: ${self:provider.stage}
    # Force email sending on every run (true) or only for new voucher codes (false)
    FORCE_EMAIL_SEND: ${env:FORCE_EMAIL_SEND, 'false'}
    # SES sender email address (must be verified in AWS SES)
    SES_SENDER_EMAIL: ${env:SES_SENDER_EMAIL, 'soosgyul@gmail.com'}
    # Note: AWS_REGION is automatically provided by Lambda runtime
  iam:
    role:
      statements:
        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            - logs:DescribeLogGroups
            - logs:DescribeLogStreams
          Resource: "*"

        # SSM Parameter Store (read account credentials)
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource:
            - arn:aws:ssm:${self:provider.region}:${aws:accountId}:parameter/octoplus/${self:provider.stage}/*

        # DynamoDB (state tracking)
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
          Resource:
            - !GetAtt OctoplusStateTable.Arn

        # SES (send emails)
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"

functions:
  caffenero:
    handler: dist/lambda.handler
    name: ${self:service}-${self:provider.stage}-caffenero
    description: "Automated Caffe Nero benefit claiming for Octoplus with email notifications"
    timeout: 30
    memorySize: 128
    logRetentionInDays: 14
    events:
      # Account 1 Schedules
      # Primary attempt: Monday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-mon
          description: "Claim Caffe Nero for Account 1 (Mon 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * MON *)
          enabled: true
          input:
            accountNumber: "1"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-mon-7
          description: "Claim Caffe Nero for Account 1 (Mon 7 AM UTC)"
          rate: cron(0 7 ? * MON *)
          enabled: true
          input:
            accountNumber: "1"
      # Retry 1: Tuesday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-tue
          description: "Retry Caffe Nero for Account 1 (Tue 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * TUE *)
          enabled: true
          input:
            accountNumber: "1"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-tue-7
          description: "Retry Caffe Nero for Account 1 (Tue 7 AM UTC)"
          rate: cron(0 7 ? * TUE *)
          enabled: true
          input:
            accountNumber: "1"
      # Retry 2: Wednesday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-wed
          description: "Retry Caffe Nero for Account 1 (Wed 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * WED *)
          enabled: true
          input:
            accountNumber: "1"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-wed-7
          description: "Retry Caffe Nero for Account 1 (Wed 7 AM UTC)"
          rate: cron(0 7 ? * WED *)
          enabled: true
          input:
            accountNumber: "1"
      # Retry 3: Thursday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-thu
          description: "Retry Caffe Nero for Account 1 (Thu 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * THU *)
          enabled: true
          input:
            accountNumber: "1"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-1-thu-7
          description: "Retry Caffe Nero for Account 1 (Thu 7 AM UTC)"
          rate: cron(0 7 ? * THU *)
          enabled: true
          input:
            accountNumber: "1"

      # Account 2 Schedules
      # Primary attempt: Monday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-mon
          description: "Claim Caffe Nero for Account 2 (Mon 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * MON *)
          enabled: true
          input:
            accountNumber: "2"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-mon-7
          description: "Claim Caffe Nero for Account 2 (Mon 7 AM UTC)"
          rate: cron(0 7 ? * MON *)
          enabled: true
          input:
            accountNumber: "2"
      # Retry 1: Tuesday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-tue
          description: "Retry Caffe Nero for Account 2 (Tue 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * TUE *)
          enabled: true
          input:
            accountNumber: "2"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-tue-7
          description: "Retry Caffe Nero for Account 2 (Tue 7 AM UTC)"
          rate: cron(0 7 ? * TUE *)
          enabled: true
          input:
            accountNumber: "2"
      # Retry 2: Wednesday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-wed
          description: "Retry Caffe Nero for Account 2 (Wed 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * WED *)
          enabled: true
          input:
            accountNumber: "2"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-wed-7
          description: "Retry Caffe Nero for Account 2 (Wed 7 AM UTC)"
          rate: cron(0 7 ? * WED *)
          enabled: true
          input:
            accountNumber: "2"
      # Retry 3: Thursday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-thu
          description: "Retry Caffe Nero for Account 2 (Thu 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * THU *)
          enabled: true
          input:
            accountNumber: "2"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-2-thu-7
          description: "Retry Caffe Nero for Account 2 (Thu 7 AM UTC)"
          rate: cron(0 7 ? * THU *)
          enabled: true
          input:
            accountNumber: "2"

      # Account 3 Schedules
      # Primary attempt: Monday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-mon
          description: "Claim Caffe Nero for Account 3 (Mon 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * MON *)
          enabled: true
          input:
            accountNumber: "3"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-mon-7
          description: "Claim Caffe Nero for Account 3 (Mon 7 AM UTC)"
          rate: cron(0 7 ? * MON *)
          enabled: true
          input:
            accountNumber: "3"
      # Retry 1: Tuesday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-tue
          description: "Retry Caffe Nero for Account 3 (Tue 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * TUE *)
          enabled: true
          input:
            accountNumber: "3"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-tue-7
          description: "Retry Caffe Nero for Account 3 (Tue 7 AM UTC)"
          rate: cron(0 7 ? * TUE *)
          enabled: true
          input:
            accountNumber: "3"
      # Retry 2: Wednesday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-wed
          description: "Retry Caffe Nero for Account 3 (Wed 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * WED *)
          enabled: true
          input:
            accountNumber: "3"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-wed-7
          description: "Retry Caffe Nero for Account 3 (Wed 7 AM UTC)"
          rate: cron(0 7 ? * WED *)
          enabled: true
          input:
            accountNumber: "3"
      # Retry 3: Thursday 5:00-7:00 AM UTC (every 10 minutes)
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-thu
          description: "Retry Caffe Nero for Account 3 (Thu 5-7 AM UTC)"
          rate: cron(0/10 5-6 ? * THU *)
          enabled: true
          input:
            accountNumber: "3"
      - schedule:
          name: ${self:service}-${self:provider.stage}-account-3-thu-7
          description: "Retry Caffe Nero for Account 3 (Thu 7 AM UTC)"
          rate: cron(0 7 ? * THU *)
          enabled: true
          input:
            accountNumber: "3"

resources:
  Resources:
    # DynamoDB table for state tracking
    OctoplusStateTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stateTableName}
        BillingMode: PAY_PER_REQUEST  # On-demand pricing (no provisioned capacity)
        AttributeDefinitions:
          - AttributeName: accountNumber
            AttributeType: S
        KeySchema:
          - AttributeName: accountNumber
            KeyType: HASH  # Partition key
        TimeToLiveSpecification:
          Enabled: true
          AttributeName: ttl  # Auto-delete expired items
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: "State tracking for weekly voucher claims"

  Outputs:
    LambdaFunctionName:
      Description: "Lambda Function Name"
      Value: ${self:service}-${self:provider.stage}-caffenero
      Export:
        Name: ${self:service}-${self:provider.stage}-function-name

    LogGroupName:
      Description: "CloudWatch Log Group for Lambda"
      Value: /aws/lambda/${self:service}-${self:provider.stage}-caffenero
      Export:
        Name: ${self:service}-${self:provider.stage}-log-group

    DynamoDBTableName:
      Description: "DynamoDB State Table Name"
      Value: ${self:custom.stateTableName}
      Export:
        Name: ${self:service}-${self:provider.stage}-state-table

    DynamoDBTableArn:
      Description: "DynamoDB State Table ARN"
      Value: !GetAtt OctoplusStateTable.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-state-table-arn

package:
  patterns:
    - 'dist/**'
    - 'node_modules/**'
    - '!src/**'
    - '!*.ts'
    - '!queries/*.ts'
    - '!.env'
  excludeDevDependencies: true